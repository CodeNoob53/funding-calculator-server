# Сервер Калькулятора Фандингу

Сервер Калькулятора Фандингу - це надійний проксі-сервер, розроблений для взаємодії з API Coinglass, що надає дані про ставки фандингу для криптовалютних ринків у реальному часі. Він служить бекендом для додатку калькулятора фандингу, пропонуючи як HTTP, так і WebSocket інтерфейси для отримання даних та оновлень у реальному часі. Побудований на Node.js, Express та Socket.IO, цей сервер забезпечує високу продуктивність, масштабованість та надійність.

## Зміст

- [Функції](#функції)
- [Архітектура](#архітектура)
- [Передумови](#передумови)
- [Встановлення](#встановлення)
- [Конфігурація](#конфігурація)
- [Запуск Сервера](#запуск-сервера)
- [API Ендпоінти](#api-ендпоінти)
- [WebSocket Події](#websocket-події)
- [Моніторинг та Логування](#моніторинг-та-логування)
- [Безпека](#безпека)
- [Внесок](#внесок)
- [Ліцензія](#ліцензія)

## Функції

- **Проксі для API Coinglass**: Отримує та кешує дані про ставки фандингу з Coinglass.
- **Оновлення в Реальному Часі**: Надає оновлення ставок фандингу в реальному часі через WebSocket.
- **Кешування**: Використовує кешування в пам'яті для зменшення API-запитів.
- **Обмеження Швидкості**: Захищає від зловживань за допомогою `express-rate-limit`.
- **Структуроване Логування**: Логи у файли та консоль за допомогою `winston` для легкого налагодження та моніторингу.
- **Моніторинг Продуктивності**: Надає метрики через Prometheus за адресою `/metrics`.
- **Автентифікація за API-ключем**: Захищає ендпоінти за допомогою API-ключа в заголовку запиту.
- **Плавне Завершення**: Обробляє сигнали завершення для чистого вимкнення сервера.
- **Модульна Архітектура**: Організована структура коду для масштабованості та підтримки.

## Архітектура

Сервер структурований як модульний Node.js додаток з наступними компонентами:

- **Express Сервер** (`src/server/index.js`): Обробляє HTTP-запити та служить основним API.
- **Socket.IO** (`src/server/socket.js`): Керує WebSocket-з'єднаннями для оновлень даних у реальному часі.
- **Маршрути** (`src/routes/`): Модульна маршрутизація для API-ендпоінтів:
  - `/api/proxy/funding-rates`: Отримує дані про ставки фандингу.
- **Кешування** (`src/routes/fundingRates.js`): Кеш у пам'яті для ефективного отримання даних.
- **Логування** (`src/utils/logger.js`): Структуроване логування з `winston` у `logs/app.log`.
- **Конфігурація** (`src/config/index.js`): Централізована конфігурація з використанням змінних середовища.
- **Проміжне ПЗ** (`src/middlewares/`): Багаторазове проміжне ПЗ для автентифікації, обмеження швидкості та метрик.
- **Точка Входу** (`src/app.js`): Основна ініціалізація сервера та логіка плавного завершення.

## Передумови

- **Node.js**: Версія 18.0.0 або вище.
- **npm**: Версія 8.0.0 або вище (або `yarn`).
- **Coinglass API Key**: Необхідний для доступу до даних про ставки фандингу.
- **Git**: Для клонування репозиторію (опціонально).

## Встановлення

1. **Клонування Репозиторію**:
   ```bash
   git clone https://github.com/your-repo/funding-calculator-server.git
   cd funding-calculator-server
   ```

2. **Встановлення Залежностей**:
   ```bash
   npm install
   ```

3. **Створення Файлу Середовища**:
   Скопіюйте файл `.env.example` до `.env` та заповніть необхідні значення:
   ```bash
   cp .env.example .env
   ```
   Відредагуйте `.env` з вашим API-ключем Coinglass та іншими налаштуваннями (див. [Конфігурація](#конфігурація)).

4. **Створення Директорії для Логів**:
   ```bash
   mkdir logs
   ```

## Конфігурація

Сервер налаштовується через змінні середовища, визначені у файлі `.env`. Нижче наведено приклад на основі `.env.example`:

```
# API-ключ Coinglass для доступу до ставок фандингу
API_KEY=your_coinglass_api_key

# URL API Coinglass
COINGLASS_API_URL=https://open-api.coinglass.com/public/v2/funding

# URL клієнта для CORS (наприклад, ваш фронтенд-додаток)
CLIENT_URL=https://your-client-app.com

# Порт сервера
PORT=3001

# Інтервал оновлення даних фандингу в мілісекундах
FUNDING_UPDATE_INTERVAL=20000

# Таймаут пінгу WebSocket в мілісекундах
SOCKET_PING_TIMEOUT=60000

# Інтервал пінгу WebSocket в мілісекундах
SOCKET_PING_INTERVAL=25000

# Налаштування логування
LOG_LEVEL=info
LOG_COLORS=true
LOG_TO_FILE=true
```

### Деталі Конфігурації

- **API_KEY**: Ваш API-ключ Coinglass (обов'язково).
- **COINGLASS_API_URL**: Ендпоінт API Coinglass для ставок фандингу (за замовчуванням: `https://open-api.coinglass.com/`).
- **CLIENT_URL**: URL фронтенду для CORS (наприклад, `https://your-client-app.com`).
- **PORT**: Порт, на якому працює сервер (за замовчуванням: `3001`).
- **FUNDING_UPDATE_INTERVAL**: Інтервал оновлення даних фандингу в мілісекундах (за замовчуванням: `20000`).
- **SOCKET_PING_TIMEOUT**: Таймаут пінгу WebSocket в мілісекундах (за замовчуванням: `60000`).
- **SOCKET_PING_INTERVAL**: Інтервал пінгу WebSocket в мілісекундах (за замовчуванням: `25000`).
- **LOG_LEVEL**: Рівень логування (`error`, `info`, `debug`, тощо; за замовчуванням: `info`).
- **LOG_COLORS**: Увімкнення кольорових логів у консолі (`true` або `false`; за замовчуванням: `true`).
- **LOG_TO_FILE**: Увімкнення логування у файл (`true` або `false`; за замовчуванням: `true`).

## Запуск Сервера

### Режим Розробки (з `nodemon` для автоматичного перезапуску):
```bash
npm run dev
```

### Виробничий Режим:
```bash
npm start
```

Сервер запуститься на вказаному `PORT` (за замовчуванням: `3001`). Ви побачите повідомлення в логах:
```
[HH:mm:ss] INFO   Server running on port 3001
```

## API Ендпоінти

### `GET /`
- **Опис**: Ендпоінт перевірки працездатності.
- **Відповідь**:
  ```
  Funding Server is running...
  ```

### `GET /api/proxy/funding-rates`
- **Опис**: Отримує дані про ставки фандингу з Coinglass, з групуванням, фільтрацією та кешуванням у пам'яті. Кеш автоматично оновлюється кожні `FUNDING_UPDATE_INTERVAL` мс.
- **Заголовки**:
  - `x-api-key: <your_api_key>` (обов'язково).
- **Параметри запиту**:
  - `symbol` (опціонально): Повертає дані лише для вказаного символу (наприклад, `BTC`).
  - `minRate` (опціонально): Фільтрує біржі за абсолютним порогом ставки фандингу.
- **Відповідь**:
  - **Успіх (200)**:
    ```json
    [
      {
        "symbol": "BTC",
        "symbolLogo": "...",
        "exchanges": [
          {
            "exchange": "Binance",
            "exchangeLogo": "...",
            "rate": 0.01,
            "predictedRate": 0.012,
            "interestRate": 0.001,
            "fundingIntervalHours": 8,
            "nextFundingTime": 1714828800000,
            "price": 65000,
            "status": 1
          }
        ]
      }
      // ...
    ]
    ```
  - **Помилка (403)**:
    ```json
    {
      "error": "API key required"
    }
    ```
  - **Помилка (502/500)**:
    ```json
    {
      "error": "Не вдалося отримати ставки фандингу з Coinglass",
      "details": "Error message"
    }
    ```

### `GET /metrics`
- **Опис**: Надає метрики Prometheus для моніторингу.
- **Відповідь**:
  Метрики, сумісні з Prometheus (наприклад, `http_request_duration_seconds`, стандартні метрики Node.js).

### `GET /api/monitoring/metrics`
- **Опис**: Надає розширені метрики Prometheus, включаючи специфічні WebSocket метрики.
- **Заголовки**:
  - `x-api-key: <your_api_key>` (обов'язково).
- **Відповідь**:
  Метрики, сумісні з Prometheus, включаючи:
  - `websocket_connections_total`: Загальна кількість WebSocket з'єднань.
  - `websocket_subscribed_connections`: Кількість підписаних WebSocket з'єднань.
  - `websocket_heartbeat_latency_avg`: Середня затримка heartbeat у мілісекундах.

## WebSocket Події

Сервер використовує Socket.IO для оновлень даних у реальному часі з розширеними функціями, такими як користувацький моніторинг heartbeat, статистика з'єднань та розумне виявлення змін.

### З'єднання
- **Подія**: `connection`
- **Автентифікація**:
  Включіть ваш API-ключ у поле `auth.apiKey` при встановленні з'єднання Socket.IO.
  ```javascript
  const socket = io('http://localhost:3001', {
    auth: { apiKey: 'your_api_key' }
  });
  ```

### Приклад WebSocket Клієнта

Підключіться до сервера та підпишіться на оновлення ставок фандингу в реальному часі:

```javascript
const { io } = require("socket.io-client");

// Підключення з автентифікацією за API-ключем
const socket = io("http://localhost:3001", {
  auth: { apiKey: "your_api_key" }
});

// Обробка початкових даних
socket.on("initialData", (data) => {
  console.log("Отримано початкові дані фандингу:", data);
});

// Обробка оновлень у реальному часі
socket.on("dataUpdate", (updates) => {
  console.log("Отримано оновлення ставок фандингу:", updates);
});

// Підписка на оновлення
socket.emit("subscribe");

// Обробка ping-подій з pong-відповіддю
socket.on("ping", (data) => {
  socket.emit("pong", data);
});

// Запит статистики з'єднання
socket.emit("getConnectionStats");
socket.on("connectionStats", (stats) => {
  console.log("Статистика з'єднання:", stats);
});

// Обробка відключення
socket.on("disconnect", (reason) => {
  console.log("Відключено:", reason);
});
```

### Події

- **`initialData`**:
  - **Опис**: Надсилається при успішному підключенні.
  - **Корисне навантаження**: Кешовані дані про ставки фандингу.
  - **Приклад**:
    ```json
    [
      {
        "symbol": "BTC",
        "symbolLogo": "...",
        "exchanges": [
          { "exchange": "Binance", "rate": 0.01, ... }
        ]
      }
      // ...
    ]
    ```

- **`dataUpdate`**:
  - **Опис**: Надсилається кожні 20 секунд (налаштовується через `FUNDING_UPDATE_INTERVAL`), якщо дані змінилися.
  - **Корисне навантаження**: Оновлені дані про ставки фандингу (той самий формат, що й `initialData`).
  - **Примітка**: Сервер реалізує алгоритм розумного виявлення змін, який надсилає лише змінені дані для зменшення використання пропускної здатності.

- **`ping`**:
  - **Опис**: Ініційований сервером heartbeat для перевірки з'єднання клієнта.
  - **Корисне навантаження**: `{ timestamp: 1714828800000 }`
  - **Очікувана відповідь**: Клієнт повинен відповісти подією `pong`, що містить той самий timestamp.

- **`pong`**:
  - **Опис**: Відповідь клієнта на подію `ping` сервера.
  - **Корисне навантаження**: `{ timestamp: 1714828800000 }` (той самий timestamp, отриманий у ping)
  - **Примітка**: Використовується для розрахунку затримки з'єднання та виявлення відключених клієнтів.

- **`subscribe`**:
  - **Опис**: Подія клієнта для підписки на оновлення ставок фандингу в реальному часі.
  - **Корисне навантаження**: Немає
  - **Відповідь**: Немає, але клієнт почне отримувати події `dataUpdate`.

- **`unsubscribe`**:
  - **Опис**: Подія клієнта для припинення отримання оновлень ставок фандингу.
  - **Корисне навантаження**: Немає
  - **Відповідь**: Немає, клієнт перестане отримувати події `dataUpdate`.

- **`getConnectionStats`**:
  - **Опис**: Запит клієнта на статистику з'єднання.
  - **Корисне навантаження**: Немає
  - **Відповідь**: Подія `connectionStats` з детальними метриками з'єднання.

- **`connectionStats`**:
  - **Опис**: Відповідь сервера зі статистикою з'єднання.
  - **Корисне навантаження**:
    ```json
    {
      "connectedAt": "2023-05-04T12:34:56.789Z",
      "sessionDuration": 3600,
      "pingCount": 120,
      "pongCount": 120,
      "missedPongs": 0,
      "currentLatency": 45,
      "averageLatency": 52,
      "isSubscribed": true
    }
    ```

- **`disconnect`**:
  - **Опис**: Спрацьовує, коли клієнт відключається.
  - **Корисне навантаження**: Причина відключення (наприклад, `transport close`).

## Моніторинг та Логування

### Логування
Логи записуються до:
- `logs/app.log`: Усі логи (info, error, тощо).
- **Консоль**: Кольорові логи для розробки.

Формат логів:
- **Консоль**: `[HH:mm:ss] LEVEL   Message`
  - Приклад: `[12:34:56] INFO   Server running on port 3001`
- **Файл (JSON)**:
  ```json
  {
    "level": "info",
    "message": "Server running on port 3001",
    "timestamp": "2025-05-04 12:34:56.789"
  }
  ```

### Моніторинг
- Метрики Prometheus доступні за адресою `/metrics`.
- Ключові метрики:
  - `http_request_duration_seconds`: Тривалість HTTP-запитів.
  - Стандартні метрики Node.js (наприклад, використання CPU, пам'яті).
- Використовуйте сервер Prometheus та Grafana для візуалізації.

## Безпека

- **Автентифікація за API-ключем**: Як WebSocket-з'єднання, так і ендпоінти `/api/proxy` вимагають дійсного API-ключа в заголовку або при встановленні з'єднання.
- **CORS**: Обмежено вказаним `CLIENT_URL`.
- **Обмеження швидкості**: Обмежує запити до `/api/proxy` до 100 за 15 хвилин на IP.
- **Змінні середовища**: Чутливі дані (наприклад, `API_KEY`) повинні бути визначені в `.env`.
- **Плавне завершення**: Забезпечує чисте завершення при `SIGTERM`.

## Внесок

1. Зробіть форк репозиторію.
2. Створіть гілку для функції (`git checkout -b feature/your-feature`).
3. Зробіть коміт змін (`git commit -m 'Add your feature'`).
4. Відправте у гілку (`git push origin feature/your-feature`).
5. Відкрийте pull request.

Будь ласка, дотримуйтесь Кодексу поведінки та переконайтесь, що всі зміни добре задокументовані.

## Ліцензія

Цей проект ліцензований під ISC License. Дивіться файл `LICENSE` для деталей.